<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fintech CRM - Deals</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
      <div class="brand">
            <div class="badge-brand"> <img src="assets/images/sodetsologo.jpg" width="50" height="50"></div>
            <div>
                <div class="fw-bold company">SODETSO CRM</div>
                <small class="company">Management System</small>
            </div>
        </div>
    
    <nav class="nav-section">
      <a href="index.html" class="nav-link">
        <i class="fas fa-tachometer-alt"></i>
        Dashboard
      </a>
      <a href="leads.html" class="nav-link">
        <i class="fas fa-users"></i>
        Leads
      </a>
      <a href="interactions.html" class="nav-link">
        <i class="fas fa-comments"></i>
        Interactions
      </a>
      <a href="deals.html" class="nav-link active">
        <i class="fas fa-handshake"></i>
        Deals
      </a>
      <a href="documents.html" class="nav-link">
        <i class="fas fa-file-alt"></i>
        Documents
      </a>
      <a href="support.html" class="nav-link">
        <i class="fas fa-headset"></i>
        Support
      </a>
      <a href="users.html" class="nav-link">
        <i class="fas fa-user-cog"></i>
        Users
      </a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main">
    <div class="topbar">
      <h1 class="page-title">Deals Management</h1>
    </div>

    <div class="content-wrapper">
      <!-- Deals Tabs -->
      <div class="card">
        <div class="card-header">
          <ul class="nav nav-tabs card-header-tabs" id="dealsTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="pipeline-management-tab" data-bs-toggle="tab" data-bs-target="#pipeline-management" type="button" role="tab" aria-controls="pipeline-management" aria-selected="true">
                <i class="fas fa-project-diagram me-2"></i>
                Pipeline Management
                <span class="badge bg-primary ms-2" id="pipelineStagesCount">6</span>
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="deals-management-tab" data-bs-toggle="tab" data-bs-target="#deals-management" type="button" role="tab" aria-controls="deals-management" aria-selected="false">
                <i class="fas fa-handshake me-2"></i>
                Deals Management
                <span class="badge bg-success ms-2" id="dealsCount">0</span>
              </button>
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="tab-content" id="dealsTabContent">
            <!-- Pipeline Management Tab -->
            <div class="tab-pane fade show active" id="pipeline-management" role="tabpanel" aria-labelledby="pipeline-management-tab">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="fas fa-project-diagram text-primary me-2"></i>Pipeline Management</h5>
                <div>
                  <button class="btn btn-outline-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#pipelineStageModal">
                    <i class="fas fa-plus me-1"></i>
                    Add Stage
                  </button>
                  <button class="btn btn-brand btn-sm" onclick="resetPipelineStages()">
                    <i class="fas fa-undo me-1"></i>
                    Reset to Default
                  </button>
                </div>
              </div>
              
              <!-- Pipeline Stages Table -->
              <div class="card shadow-sm mb-4">
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                      <thead class="table-light">
                        <tr>
                          <th><i class="fas fa-hashtag me-1"></i>Order</th>
                          <th><i class="fas fa-tag me-1"></i>Stage Name</th>
                          <th><i class="fas fa-info-circle me-1"></i>Description</th>
                          <th><i class="fas fa-percentage me-1"></i>Probability (%)</th>
                          <th><i class="fas fa-cogs me-1"></i>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="pipelineStagesTableBody">
                        <!-- Pipeline stages will be populated by JavaScript -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Pipeline Board -->
              <div class="card shadow-sm">
                <div class="card-header">
                  <h6 class="mb-0"><i class="fas fa-columns me-2"></i>Pipeline Board</h6>
                </div>
                <div class="card-body">
                  <div class="pipeline-board" id="pipelineBoard">
                    <!-- Pipeline columns will be populated by JavaScript -->
                  </div>
                </div>
              </div>

              <!-- Pipeline Summary -->
              <div class="row mt-4">
                <div class="col-md-3">
                  <div class="stat">
                    <h4>Total Deals</h4>
                    <div class="value" id="totalDeals">0</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stat">
                    <h4>Pipeline Value</h4>
                    <div class="value" id="pipelineValue">KES 0</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stat">
                    <h4>Won Deals</h4>
                    <div class="value" id="wonDeals">0</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stat">
                    <h4>Win Rate</h4>
                    <div class="value" id="winRate">0%</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Deals Management Tab -->
            <div class="tab-pane fade" id="deals-management" role="tabpanel" aria-labelledby="deals-management-tab">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="fas fa-handshake text-success me-2"></i>Deals Management</h5>
                <button class="btn btn-brand btn-sm" onclick="window.location.href='create-deal.html'">
                  <i class="fas fa-plus me-1"></i>
                  Create Deal
                </button>
              </div>
              <div class="card shadow-sm">
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                      <thead class="table-light">
                        <tr>
                          <th><i class="fas fa-heading me-1"></i>Deal Name</th>
                          <th><i class="fas fa-user me-1"></i>Owner</th>
                          <th><i class="fas fa-building me-1"></i>Institution</th>
                          <th><i class="fas fa-user-tie me-1"></i>Contact</th>
                          <th><i class="fas fa-chart-line me-1"></i>Stage</th>
                          <th><i class="fas fa-money-bill-wave me-1"></i>Value</th>
                          <th><i class="fas fa-calendar me-1"></i>Close Date</th>
                          <th><i class="fas fa-cogs me-1"></i>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="dealsTableBody">
                        <!-- Deals will be populated by JavaScript -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer">
      <div>&copy; 2024 Fintech CRM. All rights reserved.</div>
    </footer>
  </div>

  <!-- Pipeline Stage Modal -->
  <div class="modal fade" id="pipelineStageModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Pipeline Stage</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form onsubmit="handlePipelineStageForm(event)">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Stage Name *</label>
              <input type="text" class="form-control" name="stageName" placeholder="e.g., Qualification" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" name="description" rows="2" placeholder="Describe this stage..."></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Probability (%)</label>
              <input type="number" class="form-control" name="probability" placeholder="25" min="0" max="100">
            </div>
            <div class="mb-3">
              <label class="form-label">Order</label>
              <input type="number" class="form-control" name="order" placeholder="1" min="1">
              <small class="text-muted">Lower numbers appear first in the pipeline</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Stage</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="modal fade" id="pipelineStageModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Pipeline Stage</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form onsubmit="handlePipelineStageForm(event)">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Stage Name *</label>
              <input type="text" class="form-control" name="stageName" placeholder="e.g., Qualification" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" name="description" rows="2" placeholder="Describe this stage..."></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Probability (%)</label>
              <input type="number" class="form-control" name="probability" placeholder="25" min="0" max="100">
            </div>
            <div class="mb-3">
              <label class="form-label">Order</label>
              <input type="number" class="form-control" name="order" placeholder="1" min="1">
              <small class="text-muted">Lower numbers appear first in the pipeline</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Stage</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/main.js"></script>
  <script>
    // Initialize pipeline stages if not exist
    if (!store.get('pipelineStages') || store.get('pipelineStages').length === 0) {
      const defaultStages = [
        { name: 'Lead', description: 'Initial contact made', probability: 10, order: 1 },
        { name: 'Qualification', description: 'Requirements gathering and qualification', probability: 25, order: 2 },
        { name: 'Proposal', description: 'Proposal submitted to customer', probability: 50, order: 3 },
        { name: 'Negotiation', description: 'Terms and pricing negotiation', probability: 75, order: 4 },
        { name: 'Closed Won', description: 'Deal successfully closed', probability: 100, order: 5 },
        { name: 'Closed Lost', description: 'Deal lost to competitor or cancelled', probability: 0, order: 6 }
      ];
      defaultStages.forEach(stage => store.add('pipelineStages', stage));
    }

    // Populate dropdowns and initialize
    document.addEventListener('DOMContentLoaded', function() {
      const institutionSelect = document.querySelector('select[name="institutionName"]');
      const contactSelect = document.querySelector('select[name="contactName"]');
      
      const institutions = store.get('institutions');
      const contacts = store.get('contacts');
      
      institutionSelect.innerHTML = '<option value="">Select Institution</option>' +
        institutions.map(inst => `<option value="${inst.name}">${inst.name}</option>`).join('');
      
      contactSelect.innerHTML = '<option value="">Select Contact</option>' +
        contacts.map(contact => `<option value="${contact.name}">${contact.name}</option>`).join('');

      // Initialize renders
      renderPipelineStages();
      renderDeals();
      updatePipelineSummary();
      updateCounts();
    });

    function updateCounts() {
      const pipelineStages = store.get('pipelineStages') || [];
      const deals = store.get('deals') || [];
      
      document.getElementById('pipelineStagesCount').textContent = pipelineStages.length;
      document.getElementById('dealsCount').textContent = deals.length;
    }

    function renderPipelineStages() {
      const stages = store.get('pipelineStages') || [];
      const tbody = document.getElementById('pipelineStagesTableBody');
      if (!tbody) return;
      
      // Sort by order
      stages.sort((a, b) => (a.order || 999) - (b.order || 999));
      
      tbody.innerHTML = stages.map(stage => `
        <tr>
          <td>${stage.order || 'N/A'}</td>
          <td><span class="badge bg-${getStageColor(stage.name)}">${stage.name}</span></td>
          <td>${stage.description || 'N/A'}</td>
          <td>${stage.probability || 0}%</td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="editPipelineStage('${stage.id}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deletePipelineStage('${stage.id}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    function getStageColor(stageName) {
      const colors = {
        'Lead': 'secondary',
        'Qualification': 'info',
        'Proposal': 'warning',
        'Negotiation': 'primary',
        'Closed Won': 'success',
        'Closed Lost': 'danger'
      };
      return colors[stageName] || 'secondary';
    }

    function renderDeals() {
      const deals = store.get('deals') || [];
      const tbody = document.getElementById('dealsTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = deals.map(deal => `
        <tr>
          <td>${deal.name}</td>
          <td>${deal.owner}</td>
          <td>${deal.institutionName || 'N/A'}</td>
          <td>${deal.contactName || 'N/A'}</td>
          <td><span class="badge bg-${getStageColor(deal.stage)}">${deal.stage || 'Lead'}</span></td>
          <td>${formatCurrency(deal.expectedRevenue || 0)}</td>
          <td>${deal.closingDate ? new Date(deal.closingDate).toLocaleDateString() : 'N/A'}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="editDeal('${deal.id}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteDeal('${deal.id}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    function handlePipelineStageForm(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const stage = {
        name: formData.get('stageName'),
        description: formData.get('description'),
        probability: parseInt(formData.get('probability')) || 0,
        order: parseInt(formData.get('order')) || 999
      };

      store.add('pipelineStages', stage);
      bootstrap.Modal.getInstance(document.getElementById('pipelineStageModal')).hide();
      event.target.reset();
      renderPipelineStages();
      updateCounts();
      buildPipelineBoard(); // Rebuild pipeline with new stages
      showToast('Pipeline stage added successfully');
    }

    function deletePipelineStage(id) {
      if (confirm('Are you sure you want to delete this pipeline stage? This may affect existing deals.')) {
        store.delete('pipelineStages', id);
        renderPipelineStages();
        updateCounts();
        buildPipelineBoard();
        showToast('Pipeline stage deleted');
      }
    }

    function editPipelineStage(id) {
      showToast('Edit functionality coming soon');
    }

    function editDeal(id) {
      showToast('Edit functionality coming soon');
    }

    function deleteDeal(id) {
      if (confirm('Are you sure you want to delete this deal?')) {
        store.delete('deals', id);
        renderDeals();
        updateCounts();
        updatePipelineSummary();
        buildPipelineBoard();
        showToast('Deal deleted');
      }
    }

    function resetPipelineStages() {
      if (confirm('Are you sure you want to reset to default pipeline stages? This will remove all custom stages.')) {
        // Clear existing stages
        const existingStages = store.get('pipelineStages') || [];
        existingStages.forEach(stage => store.delete('pipelineStages', stage.id));
        
        // Add default stages
        const defaultStages = [
          { name: 'Lead', description: 'Initial contact made', probability: 10, order: 1 },
          { name: 'Qualification', description: 'Requirements gathering and qualification', probability: 25, order: 2 },
          { name: 'Proposal', description: 'Proposal submitted to customer', probability: 50, order: 3 },
          { name: 'Negotiation', description: 'Terms and pricing negotiation', probability: 75, order: 4 },
          { name: 'Closed Won', description: 'Deal successfully closed', probability: 100, order: 5 },
          { name: 'Closed Lost', description: 'Deal lost to competitor or cancelled', probability: 0, order: 6 }
        ];
        defaultStages.forEach(stage => store.add('pipelineStages', stage));
        
        renderPipelineStages();
        updateCounts();
        buildPipelineBoard();
        showToast('Pipeline stages reset to default');
      }
    }

    function updatePipelineSummary() {
      const deals = store.get('deals');
      const totalDeals = deals.length;
      const pipelineValue = deals.reduce((sum, deal) => sum + (deal.expectedRevenue || 0), 0);
      const wonDeals = deals.filter(deal => deal.stage === 'Closed Won').length;
      const winRate = totalDeals > 0 ? Math.round((wonDeals / totalDeals) * 100) : 0;

      document.getElementById('totalDeals').textContent = totalDeals;
      document.getElementById('pipelineValue').textContent = formatCurrency(pipelineValue);
      document.getElementById('wonDeals').textContent = wonDeals;
      document.getElementById('winRate').textContent = winRate + '%';
    }

    // Update summary when deals change
    const originalBuildPipelineBoard = buildPipelineBoard;
    buildPipelineBoard = function() {
      originalBuildPipelineBoard();
      updatePipelineSummary();
    };
  </script>
</body>
</html>